# -*- coding: utf-8 -*-
import random
from datetime import datetime
from pathlib import Path
import webbrowser
import base64

# ---------- НАСТРОЙКИ ----------
BASE_DIR = Path(__file__).resolve().parent
OUTPUT_HTML = BASE_DIR / "ticket_exam.html"

# ---------- ДАННЫЕ ВРУЧНУЮ ----------
DEFINITIONS = [
    "Сформулируйте аксиому непрерывности для вещественных чисел.",
    "Сформулируйте определение верхней и нижней грани, а также максимума множества (определения 2.9, 2.10).",
    "Сформулируйте определение точной верхней и нижней грани (определения 2.12, 2.14).",
    "Приведите определение числовой последовательности (определение 3.1).",
    "Приведите определение предела числовой последовательности (определение 3.3).",
    "Сформулируйте лемму об отделимости для сходящейся числовой последовательности (лемма 3.10).",
    "Перечислите арифметические свойства предела последовательности (теорема 3.11).",
    "Сформулируйте теорему о переходе к пределу в неравенстве (предложение ??).",
    "Приведите формулировку леммы о зажатой последовательности (лемма 3.13).",
    "Приведите формулировку теоремы Вейерштрасса о пределе последовательности (теорема 3.14).",
    "Определите число $e$ (определение 3.17).",
    "Сформулируйте принцип вложенных отрезков (теорема 3.18).",
    "Что такое подпоследовательность и частичный предел? (определение 3.19).",
    "Что такое верхний и нижний пределы последовательности? (определение 3.21).",
    "Приведите формулировку теоремы о том, какие значения может принимать частичный предел ограниченной последовательности (теорема 3.22).",
    "Сформулируйте теорему Больцано (следствие 3.23).",
    "Сформулируйте критерий сходимости последовательности в терминах частичных пределов (теорема 3.24).",
    "Что такое фундаментальная последовательность? (определение 3.25).",
    "Сформулируйте критерий Коши для последовательности (теорема 3.28).",
    "Что такое числовой ряд? (определение 3.31).",
    "Сформулируйте критерий Коши для числовых рядов (теорема 3.33).",
    "Каково необходимое условие сходимости числового ряда? (следствие 3.34).",
    "Что такое гармонический ряд? Сходится ли он? (пример 3.35).",
    "Определите абсолютную и условную сходимость ряда (определение 3.37).",
    "Приведите формулировку теоремы об ограниченности частичных сумм сходящегося ряда с неотрицательными членами (предложение 3.39).",
    "Сформулируйте признак сравнения для числовых рядов (предложение 3.40).",
    "Сформулируйте признак Коши (теорема 3.41).",
    r"При каких значениях параметра $p$ сходится и расходится ряд $\sum_{n=1}^{\infty} \frac{1}{n^p}$? (пример 3.42).",
    "Сформулируйте определение перестановки слагаемых в рядах (определение 3.43).",
    "Сформулируйте теорему Римана (теорема 3.45).",
    "Какие множества называют открытыми?",
    "Какие множества называют замкнутыми?",
    "Сформулируйте четыре эквивалентных описания замкнутого множества.",
    "Что означает термин «внутренняя точка множества»? (определение 4.2).",
    "Что означает термин «предельная точка множества»? (определение 4.2).",
    "Что означает термин «граничная точка множества»? (определение 4.2).",
    "Приведите определения предела функции (по множеству) по Коши (определение 4.6).",
    "Приведите определения предела функции (по множеству) по Гейне (определение 4.5).",
    "Сформулируйте теорему о пределе сложной функции (теорема 4.13).",
    "Как выглядит первый замечательный предел? (предложение 4.14).",
    "Как выглядит второй замечательный предел? (предложение 4.15).",
    "Сформулируйте критерий Коши существования предела функции (теорема 4.16).",
    "Определите понятие одностороннего предела функции (определение 4.17).",
    "Сформулируйте теорему Вейерштрасса о существовании односторонних пределов монотонной ограниченной функции (теорема 4.18).",
    "Определите отношение эквивалентности функций (определение 4.24).",
    r"Что означает, что функция является бесконечно малой относительно другой ($o$)? (определение 4.31).",
    r"Что означает, что функция является ограниченной относительно другой ($O$)? (определение 4.33).",
    r"Сформулируйте теорему о связи отношения эквивалентности и представления функции с помощью $o$ (теорема 4.32).",
    r"Приведите любые три свойства $o$ и $O$ из семинарской задачи или теоремы 4.34."
]

PROOFS = [
    "Представление вещественных чисел в виде десятичных дробей (определения 2.4, 2.6). Принцип полноты, его выполнение для десятичных дробей (теорема 2.7).",
    "Верхняя грань и нижняя грань, максимум и минимум множества (определения 2.9, 2.10). Точные верхние и нижние грани, их существование у ограниченных множеств (определения 2.12, 2.14, теорема 2.15).",
    "Предел последовательности, его основные свойства: единственность, ограниченность сходящейся последовательности (определения 3.1, 3.3, 3.8, предложения 3.7, 3.9).",
    "Лемма об отделимости (лемма 3.10), арифметические свойства предела последовательности (теорема 3.11).",
    "Переход к пределу в неравенствах и лемма о зажатой последовательности (предложение ??, лемма 3.13).",
    "Теорема Вейерштрасса о пределе монотонной ограниченной последовательности (теорема 3.14).",
    r"Вычисление $\sqrt{2}$ с помощью рекуррентной формулы $a_{n+1} = \frac{1}{2}\left(a_n + \frac{2}{a_n}\right)$, обоснование сходимости (пример 3.15).",
    "Число $e$ — определение и обоснование корректности (предложение 3.16, определение 3.17).",
    "Принцип вложенных отрезков (теорема 3.18), геометрическая интерпретация вещественных чисел.",
    "Подпоследовательность и частичные пределы (определение 3.19, предложение 3.20). Верхний и нижний пределы ограниченной последовательности (определение 3.21), их связь с множеством частичных пределов этой последовательности (теорема 3.22).",
    "Теорема Больцано (следствие 3.23). Критерий сходимости последовательности в терминах частичных пределов (теорема 3.24).",
    "Фундаментальная последовательность и критерий Коши (определение 3.25, предложение 3.27, теорема 3.28).",
    r"Вычисление $\sqrt{2}$ с помощью рекуррентной формулы $a_{n+1} = 1 + \frac{1}{1+a_n}$, обоснование сходимости (пример 3.29).",
    "Числовые ряды (определение 3.31), критерий Коши для числовых рядов (теорема 3.33), необходимое условие сходимости числового ряда (следствие 3.34). Расходимость гармонического ряда (пример 3.35).",
    "Абсолютная и условная сходимость рядов (определение 3.37). Сходимость абсолютно сходящегося ряда (следствие 3.36). Ограниченность частичных сумм сходящегося ряда с неотрицательными членами (предложение 3.39). Признак сравнения (предложение 3.40).",
    r"Признак Лобачевского-Коши (теорема 3.41). Сходимость и расходимость рядов $\sum_{n=1}^{\infty} \frac{1}{n^p}$ в зависимости от параметра $p$ (пример 3.42).",
    "Перестановки слагаемых в рядах (определение 3.43). Теорема о независимости суммы абсолютно сходящегося ряда от порядка слагаемых (теорема 3.44). Теорема Римана (теорема 3.45, без доказательства).",
    "Определения предела функции (по множеству) по Коши (определение 4.6) и по Гейне (определение 4.5), их эквивалентность (теорема 4.10).",
    "Единственность и арифметические свойства предела функции: линейность, предел произведения и отношения (теорема 4.11).",
    "Предел и неравенства, ограниченность, отделимость (теорема 4.12). Теорема о пределе сложной функции (теорема 4.13).",
    "Замечательные пределы (предложения 4.14, 4.15).",
    "Критерий Коши существования предела функции (теорема 4.16).",
    "Односторонние пределы и теорема Вейерштрасса о существовании односторонних пределов монотонной ограниченной функции (определение 4.17, теорема 4.18).",
    "Отношение эквивалентности функций, примеры эквивалентных функций, лемма о эквивалентности произведения и композиции функций, предел эквивалентных функций (определение 4.24, леммы 4.25, 4.26, 4.27, 4.29).",
    r"Понятие функции, бесконечно малой или ограниченной относительно другой ($o$ и $O$), теорема о связи отношения эквивалентности и представления функции с помощью $o$, свойства $o$ и $O$ (определения 4.31, 4.33, теоремы 4.32, 4.34)."
]

CLOSED = [
    r"Вычисление $\sqrt{2}$ с помощью рекуррентной формулы $a_{n+1} = \frac{1}{2}\left(a_n + \frac{2}{a_n}\right)$, обоснование сходимости (пример 3.15).",
    r"Вычисление $\sqrt{2}$ с помощью рекуррентной формулы $a_{n+1} = 1 + \frac{1}{1+a_n}$, обоснование сходимости (пример 3.29).",
    r"Сходимость и расходимость рядов $\sum_{n=1}^{\infty} \frac{1}{n^p}$ в зависимости от параметра $p$ (пример 3.42).",
    "Расходимость гармонического ряда (пример 3.35).",
    "Теорема Римана (теорема 3.45, без доказательства)."
]

# ---------- ОТВЕТЫ (заполните вручную) ----------
ANSWERS_DEFS = {
    "Сформулируйте аксиому непрерывности для вещественных чисел.": (
        "Аксиома непрерывности (полноты) ℝ: любое непустое ограниченное сверху подмножество ℝ "
        "имеет точную верхнюю грань (супремум)."
    ),

    "Сформулируйте определение верхней и нижней грани, а также максимума множества (определения 2.9, 2.10).": (
        "Пусть A⊂ℝ. Число M — верхняя грань (majorant), если ∀a∈A: a≤M. "
        "m — нижняя грань, если ∀a∈A: m≤a. Максимум — элемент max A∈A, такой что ∀a∈A: a≤max A."
    ),

    "Сформулируйте определение точной верхней и нижней грани (определения 2.12, 2.14).": (
        "Супремум sup A — наименьшая из верхних граней: sup A — верхняя грань и если M — любая верхняя грань, "
        "то sup A ≤ M. Аналогично, inf A — наибольшая из нижних граней."
    ),

    "Приведите определение числовой последовательности (определение 3.1).": (
        "Числовая последовательность {a_n} — функция a: ℕ→ℝ, где a(n)=a_n."
    ),

    "Приведите определение предела числовой последовательности (определение 3.3).": (
        "Число a∈ℝ — предел {a_n}, если ∀ε>0 ∃N: ∀n≥N выполняется |a_n−a|<ε. "
        "Обозначения: a_n→a, a=\\lim_{n\\to\\infty} a_n."
    ),

    "Сформулируйте лемму об отделимости для сходящейся числовой последовательности (лемма 3.10).": (
        "Если a_n→a и a≠0, то ∃N: ∀n>N выполняется |a_n|>|a|/2>0."
    ),

    "Перечислите арифметические свойства предела последовательности (теорема 3.11).": (
        "Если a_n→a и b_n→b, то: "
        "1) \\(\\lim(\\alpha a_n+\\beta b_n)=\\alpha a+\\beta b\\); "
        "2) \\(\\lim(a_n b_n)=ab\\); "
        "3) если b\\neq0 и b_n\\neq0, то \\(\\lim\\frac{a_n}{b_n}=\\frac{a}{b}\\); "
        "предел единственен."
    ),

    "Сформулируйте теорему о переходе к пределу в неравенстве (предложение ??).": (
        "Если a_n≤b_n при всех достаточно больших n и a_n→a, b_n→b, то a≤b."
    ),

    "Приведите формулировку леммы о зажатой последовательности (лемма 3.13).": (
        "Если a_n→a, b_n→a и начиная с некоторого N выполняется a_n≤c_n≤b_n, то c_n→a."
    ),

    "Приведите формулировку теоремы Вейерштрасса о пределе последовательности (теорема 3.14).": (
        "Неубывающая и ограниченная сверху последовательность сходится к \\(\\sup\\{a_n\\}\\); "
        "невозрастающая, ограниченная снизу — к \\(\\inf\\{a_n\\}\\)."
    ),

    "Определите число $e$ (определение 3.17).": (
        "Определение: \\(e=\\lim_{n\\to\\infty}\\left(1+\\tfrac{1}{n}\\right)^n=\\sum_{k=0}^{\\infty}\\tfrac{1}{k!}\\)."
    ),

    "Сформулируйте принцип вложенных отрезков (теорема 3.18).": (
        "Для любой последовательности вложенных отрезков \\([a_n,b_n]\\) с длинами \\(b_n-a_n\\to0\\) "
        "существует единственная общая точка \\(\\bigcap_n [a_n,b_n]\\)."
    ),

    "Что такое подпоследовательность и частичный предел? (определение 3.19).": (
        "Если \\(n_1<n_2<\\dots\\), то подпоследовательность — \\(b_k=a_{n_k}\\). Точка L — частичный предел, "
        "если существует подпоследовательность, сходящаяся к L."
    ),

    "Что такое верхний и нижний пределы последовательности? (определение 3.21).": (
        "Верхний/нижний пределы: \\(\\overline{\\lim}\\,a_n=\\lim_{n\\to\\infty}(\\sup_{k\\ge n} a_k)\\), "
        "\\(\\underline{\\lim}\\,a_n=\\lim_{n\\to\\infty}(\\inf_{k\\ge n} a_k)\\)."
    ),

    "Приведите формулировку теоремы о том, какие значения может принимать частичный предел ограниченной последовательности (теорема 3.22).": (
        "Для ограниченной последовательности множество частичных пределов — непустое, замкнутое; "
        "его \\(\\max\\) и \\(\\min\\) равны \\(\\overline{\\lim}\\) и \\(\\underline{\\lim}\\) соответственно."
    ),

    "Сформулируйте теорему Больцано (следствие 3.23).": (
        "В любой ограниченной последовательности существует сходящаяся подпоследовательность "
        "(Больцано–Вейерштрасс)."
    ),

    "Сформулируйте критерий сходимости последовательности в терминах частичных пределов (теорема 3.24).": (
        "Ограниченная последовательность сходится ⇔ множество её частичных пределов состоит из одной точки."
    ),

    "Что такое фундаментальная последовательность? (определение 3.25).": (
        "{a_n} — фундаментальная (Коши), если ∀ε>0 ∃N: ∀n,m≥N |a_n−a_m|<ε."
    ),

    "Сформулируйте критерий Коши для последовательности (теорема 3.28).": (
        "Последовательность в ℝ сходится ⇔ она фундаментальна."
    ),

    "Что такое числовой ряд? (определение 3.31).": (
        "Ряд — выражение \\(\\sum_{k=1}^{\\infty} a_k\\); его частичные суммы \\(S_n=\\sum_{k=1}^{n} a_k\\). "
        "Ряд сходится, если существует \\(\\lim_{n\\to\\infty} S_n\\)."
    ),

    "Сформулируйте критерий Коши для числовых рядов (теорема 3.33).": (
        "Ряд \\(\\sum a_k\\) сходится ⇔ для ∀ε>0 ∃N: ∀n≥N, ∀p≥1: "
        "\\(\\left|\\sum_{k=n+1}^{n+p} a_k\\right|<ε\\)."
    ),

    "Каково необходимое условие сходимости числового ряда? (следствие 3.34).": (
        "Если \\(\\sum a_k\\) сходится, то \\(a_k\\to0\\)."
    ),

    "Что такое гармонический ряд? Сходится ли он? (пример 3.35).": (
        "Гармонический ряд \\(\\sum_{k=1}^{\\infty} \\tfrac{1}{k}\\) — расходится."
    ),

    "Определите абсолютную и условную сходимость ряда (определение 3.37).": (
        "Ряд сходится абсолютно, если сходится \\(\\sum |a_k|\\). Условная сходимость — ряд сходится, "
        "но \\(\\sum |a_k|\\) расходится."
    ),

    "Приведите формулировку теоремы об ограниченности частичных сумм сходящегося ряда с неотрицательными членами (предложение 3.39).": (
        "Если все члены ряда неотрицательны и ряд сходится, то его частичные суммы неубывают и ограничены сверху."
    ),

    "Сформулируйте признак сравнения для числовых рядов (предложение 3.40).": (
        "Если \\(0\\le a_k\\le b_k\\) и \\(\\sum b_k\\) сходится, то \\(\\sum a_k\\) тоже сходится; "
        "если \\(a_k\\ge b_k\\ge0\\) и \\(\\sum b_k\\) расходится, то \\(\\sum a_k\\) расходится."
    ),

    "Сформулируйте признак Коши (теорема 3.41).": (
        "Признак Лобачевского–Коши для рядов с положительными членами: "
        "если \\(\\sqrt[n]{a_n}\\to q<1\\) (или аналогичное условие), то ряд сходится; если \\(\\limsup\\sqrt[n]{a_n}>1\\), то расходится."
    ),

    r"При каких значениях параметра $p$ сходится и расходится ряд $\sum_{n=1}^{\infty} \frac{1}{n^p}$? (пример 3.42).": (
        "Сходится при \\(p>1\\), расходится при \\(p\\le1\\)."
    ),

    "Определите отношение эквивалентности функций (определение 4.24).": (
        "Функции f и g эквивалентны при x→x₀, если \\(\\lim_{x\\to x_0} \\tfrac{f(x)}{g(x)}=1\\). "
        "Это отношение эквивалентности на подходящем классе функций."
    ),

    r"Что означает, что функция является бесконечно малой относительно другой ($o$)? (определение 4.31).": (
        "Запись \\(f(x)=o(g(x))\\) при x→x₀ означает \\(\\lim_{x\\to x_0}\\tfrac{f(x)}{g(x)}=0\\)."
    ),

    r"Что означает, что функция является ограниченной относительно другой ($O$)? (определение 4.33).": (
        "Запись \\(f(x)=O(g(x))\\) при x→x₀ означает: ∃C>0,δ>0 такие, что для всех x в проколотой "
        "окрестности \\(|f(x)|\\le C|g(x)|\\)."
    ),

    r"Сформулируйте теорему о связи отношения эквивалентности и представления функции с помощью $o$ (теорема 4.32).": (
        "Если \\(f\\sim g\\) при x→x₀, то \\(f(x)=g(x)+o(g(x))\\) при x→x₀, и наоборот: из представления "
        "\\(f=g+o(g)\\) следует \\(f\\sim g\\)."
    ),

    r"Приведите любые три свойства $o$ и $O$ из семинарской задачи или теоремы 4.34.": (
        "Примеры: 1) \\(o(f)\\pm o(f)=o(f)\\); 2) \\(o(f)=O(f)\\); 3) \\(O(f)\\cdot O(g)=O(fg)\\); "
        "4) \\((o(f))^{\\alpha}=o(f^{\\alpha})\\) при \\(\\alpha>0\\)."
    ),
}

ANSWERS_PROOFS = {
    "Представление вещественных чисел в виде десятичных дробей (определения 2.4, 2.6). Принцип полноты, его выполнение для десятичных дробей (теорема 2.7).": (
        "Идея: каждому бесконечному десятичному разложению сопоставляется последовательность вложенных "
        "отрезков длины \\(10^{-n}\\); по принципу вложенных отрезков существует единственная общая точка — "
        "число с данным разложением. Полнота ℝ гарантирует существование супремумов и корректность представления."
    ),

    "Верхняя грань и нижняя грань, максимум и минимум множества (определения 2.9, 2.10). Точные верхние и нижние грани, их существование у ограниченных множеств (определения 2.12, 2.14, теорема 2.15).": (
        "Для непустого ограниченного сверху множества существует sup; он единственен. Аналогично для inf. "
        "Доказательство единственности: две разные ‘точные’ верхние грани противоречат минимальности."
    ),

    "Предел последовательности, его основные свойства: единственность, ограниченность сходящейся последовательности (определения 3.1, 3.3, 3.8, предложения 3.7, 3.9).": (
        "Единственность: если \\(a_n\\to a\\) и \\(a_n\\to b\\), то из ε-N определения следует \\(a=b\\). "
        "Сходящаяся последовательность ограничена (оценка через ε=1)."
    ),

    "Лемма об отделимости (лемма 3.10), арифметические свойства предела последовательности (теорема 3.11).": (
        "Отделимость: при \\(a_n\\to a\\ne0\\) модуль членов в хвосте отделён от 0. "
        "Арифметика пределов: линейность, произведение, частное (при не нулевом пределе знаменателя)."
    ),

    "Переход к пределу в неравенствах и лемма о зажатой последовательности (предложение ??, лемма 3.13).": (
        "Если \\(a_n\\le b_n\\) и \\(a_n\\to a\\), \\(b_n\\to b\\), то \\(a\\le b\\). "
        "Зажатая: если \\(a_n\\le c_n\\le b_n\\) и края сходятся к одному числу a, то и \\(c_n\\to a\\)."
    ),

    "Теорема Вейерштрасса о пределе монотонной ограниченной последовательности (теорема 3.14).": (
        "Неубывающая, ограниченная сверху \\(\\{a_n\\}\\) сходится к \\(\\sup a_n\\) (и аналог для невозрастающей/inf)."
    ),

    r"Вычисление $\sqrt{2}$ с помощью рекуррентной формулы $a_{n+1} = \frac{1}{2}\left(a_n + \frac{2}{a_n}\right)$, обоснование сходимости (пример 3.15).": (
        "Показываем положительность и убывание к фиксированной точке: решаем \\(L=\\tfrac{1}{2}(L+\\tfrac{2}{L})\\) ⇒ "
        "\\(L^2=2\\), при стартовом \\(a_1>0\\) получаем \\(a_n\\searrow\\sqrt2\\)."
    ),

    "Число $e$ — определение и обоснование корректности (предложение 3.16, определение 3.17).": (
        "Последовательность \\(a_n=(1+1/n)^n\\) монотонно возрастает и ограничена сверху ⇒ сходится; её пределом "
        "по определению является число \\(e\\). Также \\(e=\\sum_{k\\ge0}1/k!\\)."
    ),

    "Принцип вложенных отрезков (теорема 3.18), геометрическая интерпретация вещественных чисел.": (
        "Для \\([a_n,b_n]\\) вложенных и \\(b_n-a_n\\to0\\) существует единственная общая точка. "
        "Десятичные дроби реализуются как такие пересечения."
    ),

    "Подпоследовательность и частичные пределы (определение 3.19, предложение 3.20). Верхний и нижний пределы ограниченной последовательности (определение 3.21), их связь с множеством частичных пределов этой последовательности (теорема 3.22).": (
        "Множество частичных пределов ограниченной последовательности непусто и замкнуто; его экстремумы — "
        "\\(\\overline{\\lim}\\) и \\(\\underline{\\lim}\\)."
    ),

    "Теорема Больцано (следствие 3.23). Критерий сходимости последовательности в терминах частичных пределов (теорема 3.24).": (
        "Из всякой ограниченной последовательности можно выделить сходящуюся подпоследовательность. "
        "Ограниченная \\(\\{a_n\\}\\) сходится ⇔ множество её частичных пределов — одна точка."
    ),

    "Фундаментальная последовательность и критерий Коши (определение 3.25, предложение 3.27, теорема 3.28).": (
        "Определение Коши + эквивалентность сходимости в ℝ (полнота): сходится ⇔ фундаментальна."
    ),

    r"Вычисление $\sqrt{2}$ с помощью рекуррентной формулы $a_{n+1} = 1 + \frac{1}{1+a_n}$, обоснование сходимости (пример 3.29).": (
        "Разность соседних членов геометрически убывает (см. замечание 3.30) ⇒ сходимость; предел удовлетворяет "
        "\\(L=1+\\frac{1}{1+L}\\Rightarrow L=\\sqrt2\\)."
    ),

    "Числовые ряды (определение 3.31), критерий Коши для числовых рядов (теорема 3.33), необходимое условие сходимости числового ряда (следствие 3.34). Расходимость гармонического ряда (пример 3.35).": (
        "Сходимость ряда ⇔ условие Коши на хвосты; необходимое условие — члены стремятся к 0; "
        "гармонический ряд расходится."
    ),

    "Абсолютная и условная сходимость рядов (определение 3.37). Сходимость абсолютно сходящегося ряда (следствие 3.36). Ограниченность частичных сумм сходящегося ряда с неотрицательными членами (предложение 3.39). Признак сравнения (предложение 3.40).": (
        "Абсолютная сходимость ⇒ сходимость. Для неотрицательных членов частичные суммы монотонно возрастают и "
        "ограничены при сходимости. Признак сравнения как в словаре определений."
    ),

    r"Признак Лобачевского-Коши (теорема 3.41). Сходимость и расходимость рядов $\sum_{n=1}^{\infty} \frac{1}{n^p}$ в зависимости от параметра $p$ (пример 3.42).": (
        "Формулировка признака через корни/отношения; p-ряд: сходится при p>1, расходится при p≤1."
    ),

    "Перестановки слагаемых в рядах (определение 3.43). Теорема о независимости суммы абсолютно сходящегося ряда от порядка слагаемых (теорема 3.44). Теорема Римана (теорема 3.45, без доказательства).": (
        "Абсолютно сходящиеся ряды инвариантны к перестановкам членов; для условно сходящихся (Риман) возможна "
        "перестановкой любая заданная сумма/расходимость."
    ),

    "Определения предела функции (по множеству) по Коши (определение 4.6) и по Гейне (определение 4.5), их эквивалентность (теорема 4.10).": (
        "Коши: \\(\\forall\\varepsilon\\,\\exists\\delta\\,\\forall x\\in D\\cap B'_{\\delta}(a): |f(x)-A|<\\varepsilon\\). "
        "Гейне: для всякой \\(x_n\\to a\\) (в D\\{a}) имеем \\(f(x_n)\\to A\\). Теорема 4.10: определения эквивалентны."
    ),

    "Единственность и арифметические свойства предела функции: линейность, предел произведения и отношения (теорема 4.11).": (
        "Если пределы существуют, то выполняются свойства: единственность; линейность; "
        "предел произведения; предел частного (при ненулевом пределе знаменателя)."
    ),

    "Предел и неравенства, ограниченность, отделимость (теорема 4.12). Теорема о пределе сложной функции (теорема 4.13).": (
        "Сохранение неравенств в пределе; ограниченность/отделимость; если \\(g(x)\\to b\\) и \\(f(y)\\to A\\) при \\(y\\to b\\), "
        "то \\(f(g(x))\\to A\\)."
    ),

    "Замечательные пределы (предложения 4.14, 4.15).": (
        "Классические формулы, например \\(\\lim_{x\\to0}\\frac{\\sin x}{x}=1\\), "
        "\\(\\lim_{x\\to0}\\frac{1-\\cos x}{x^2}=\\tfrac12\\), и др."
    ),

    "Критерий Коши существования предела функции (теорема 4.16).": (
        "Предел функции в точке существует ⇔ выполняется условие Коши для значений функции в проколотой окрестности точки."
    ),

    "Односторонние пределы и теорема Вейерштрасса о существовании односторонних пределов монотонной ограниченной функции (определение 4.17, теорема 4.18).": (
        "Определяются левый/правый пределы; монотонная и ограниченная функция имеет односторонние пределы в каждой точке."
    ),

    "Отношение эквивалентности функций, примеры эквивалентных функций, лемма о эквивалентности произведения и композиции функций, предел эквивалентных функций (определение 4.24, леммы 4.25, 4.26, 4.27, 4.29).": (
        "Если \\(f\\sim g\\) и \\(h\\sim k\\), то \\(fh\\sim gk\\); при подходящих условиях эквивалентность сохраняется "
        "под композицией; из \\(f\\sim g\\) следует совпадение пределов при умножении/делении и т.п."
    ),

    "Понятие функции, бесконечно малой или ограниченной относительно другой ($o$ и $O$), теорема о связи отношения эквивалентности и представления функции с помощью $o$, свойства $o$ и $O$ (определения 4.31, 4.33, теоремы 4.32, 4.34).": (
        "Определения o/O; связь \\(f\\sim g\\iff f=g+o(g)\\); базовые правила для o и O: "
        "линейность с константами, замкнутость относительно произведения/степеней и т.п."
    ),
}


ANSWERS_CLOSED = {
    # Примеры ответов - заполните остальные
    r"Сходимость и расходимость рядов $\sum_{n=1}^{\infty} \frac{1}{n^p}$ в зависимости от параметра $p$ (пример 3.42).": """
        <strong>Ответ:</strong>
        <ul>
        <li>При $p > 1$ ряд сходится</li>
        <li>При $p ≤ 1$ ряд расходится</li>
        </ul>
        <strong>Доказательство:</strong> Используется интегральный признак Коши.
    """,
    # Добавьте остальные ответы здесь
}


# ---------- HTML-ПОМОЩНИКИ ----------
def escape_html(s: str) -> str:
    return s.replace("&", "&amp;").replace("<", "&lt;").replace(">", "&gt;")


def block(title: str, body_html: str) -> str:
    return f"""
    <div class="section">
      <h2>{title}</h2>
      {body_html}
    </div>
    """


def question_with_answer(question: str, answer_dict: dict, question_type: str) -> str:
    """Генерирует HTML для вопроса с возможностью показа ответа"""
    question_id = f"{question_type}_{hash(question) % 10000}"
    answer = answer_dict.get(question, "Ответ пока не добавлен")

    return f"""
    <div class="question">
      <div class="question-text">{question}</div>
      <button class="show-answer-btn" onclick="toggleAnswer('{question_id}')">
        Показать ответ
      </button>
      <div id="{question_id}" class="answer">
        <div class="answer-content">{answer}</div>
      </div>
    </div>
    """


def qlist_with_answers(items: list[str], answers_dict: dict, question_type: str) -> str:
    """Генерирует нумерованный список вопросов с ответами"""
    questions_html = ""
    for i, item in enumerate(items, 1):
        questions_html += f"""
        <li class="math">
          {question_with_answer(item, answers_dict, f"{question_type}_{i}")}
        </li>
        """
    return f"<ol>{questions_html}</ol>"


def closed_with_answer(question: str, answers_dict: dict) -> str:
    """Генерирует HTML для закрытой задачи с ответом"""
    return f"""
    <div class="closed-question">
      {question_with_answer(question, answers_dict, "closed")}
    </div>
    """


# ---------- ГЕНЕРАЦИЯ HTML ----------
def generate_html(defs, closed, proofs, outfile: Path):
    W_DEF, W_CLS, W_PRF = 0.5, 1.0, 2.5
    MAX_BASE = 4 * W_DEF + W_CLS + 2 * W_PRF
    now = datetime.now().strftime("%d.%m.%Y %H:%M")

    html = f"""<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script>
  window.MathJax = {{
    tex: {{ 
      inlineMath: [['$', '$'], ['\\\\(', '\\\\)']],
      displayMath: [['$$', '$$'], ['\\\\[', '\\\\]']],
      processEscapes: true,
      packages: {{'[+]': ['ams']}}
    }},
    svg: {{ fontCache: 'global' }}
  }};
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
<title>Коллоквиум I — билет</title>
<style>
  body {{font-family: "Times New Roman", serif; max-width: 1100px; margin: 0 auto; padding: 24px; line-height: 1.6}}
  h1 {{text-align:center; margin-bottom: 8px}}
  .meta {{text-align:center; color:#666; margin-bottom:24px}}
  .section {{background:#fff; border:1px solid #eaeaea; border-radius:10px; padding:18px; margin:18px 0; box-shadow:0 2px 8px rgba(0,0,0,.04)}}
  ol {{margin-left: 20px; padding-left: 20px}}
  .math {{font-family: inherit}}

  /* Стили для вопросов и ответов */
  .question {{margin: 15px 0; padding: 15px; border-left: 3px solid #e0e0e0; background: #fafafa}}
  .question-text {{font-weight: bold; margin-bottom: 10px}}
  .show-answer-btn {{
    padding: 8px 16px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
  }}
  .show-answer-btn:hover {{background: #45a049}}
  .answer {{
    display: none;
    margin-top: 15px;
    padding: 15px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }}
  .answer-content {{line-height: 1.5}}
  .answer.show {{display: block}}

  .closed-question {{margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px}}

  .score {{background:#f5fbff; border-left:4px solid #1f7ae0; padding:12px; border-radius:8px;}}
  .score-row {{display:flex; align-items:center; gap:12px; margin:8px 0}}
  .score-row label {{min-width:260px; font-weight:600}}
  input[type=number] {{width:90px; padding:6px}}
  .total {{font-size:20px; font-weight:700; text-align:center; margin-top:16px; background:#eaf8ea; border:2px solid #4CAF50; border-radius:10px; padding:12px}}
  .timerbar {{display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin:12px 0}}
  button {{padding:10px 14px; border:0; border-radius:8px; background:#4CAF50; color:#fff; cursor:pointer}}
  button.secondary {{background:#607D8B}}
  .timer {{position:fixed; right:20px; top:20px; background:#f0f0f0; font-weight:700; font-size:36px; padding:16px 20px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,.2)}}
  .urgent {{background:#ffcccc; color:#900; animation:pulse 1s infinite}}
  @keyframes pulse {{0%{{transform:scale(1)}} 50%{{transform:scale(1.05)}} 100%{{transform:scale(1)}}}}
  .hint {{color:#666; font-style:italic; text-align:center; margin-top:8px}}
</style>
</head>
<body>
  <h1>Коллоквиум I — билет</h1>
  <div class="meta">Дата: {now}. Базовый максимум: {MAX_BASE} баллов (8). Доп. задача: +1 или +2 по правилам.</div>

  <div class="section">
    <h2>Таймеры (регламент)</h2>
    <div class="timerbar">
      <button onclick="startTimer(40*60)">Подготовка 40 мин</button>
      <button onclick="startTimer(10*60)">Сдача ассистенту 10 мин</button>
      <button onclick="startTimer(30*60)">Сдача преподавателю 30 мин</button>
      <button onclick="startTimer(20*60)">Решение доп. задачи 20 мин</button>
      <button onclick="startTimer(10*60)">Защита доп. задачи 10 мин</button>
      <button class="secondary" onclick="resetTimer()">Сброс</button>
    </div>
    <div id="timer" class="timer">00:00</div>
    <div class="hint">Под правила: подготовка — к п.2–3, остальное — согласно описанию коллоквиума.</div>
  </div>

  {block("1) Четыре определения (каждое по 0.5)", qlist_with_answers(defs, ANSWERS_DEFS, "def"))}
  {block("2) Одна теоретическая задача из закрытого пула (1 балл)", closed_with_answer(closed, ANSWERS_CLOSED))}
  {block("3) Два доказательства (каждое до 2.5)", qlist_with_answers(proofs, ANSWERS_PROOFS, "proof"))}

  <div class="section">
    <h2>Оценивание</h2>
    <div class="score">
      <div class="score-row"><label>Определения (суммарно, 0–2):</label><input id="s_defs" type="number" min="0" max="2" step="0.1" oninput="recalc()"></div>
      <div class="score-row"><label>Закрытая задача (0–1):</label><input id="s_closed" type="number" min="0" max="1" step="0.1" oninput="recalc()"></div>
      <div class="score-row"><label>Доказательства (суммарно, 0–5):</label><input id="s_proofs" type="number" min="0" max="5" step="0.1" oninput="recalc()"></div>
      <div class="score-row"><label>Доп. задача (+0, +1, +2):</label><input id="s_extra" type="number" min="0" max="2" step="1" oninput="recalc()"></div>
      <div class="hint">Если до 6 баллов — можно +1; если 6.5–8 — можно +1 или +2.</div>
    </div>
    <div id="total" class="total">Итог: 0.00 / 8 (+доп до 2)</div>
  </div>

<script>
let timerInterval = null;
let timeLeft = 0;

// Функция для показа/скрытия ответов
function toggleAnswer(answerId) {{
  const answer = document.getElementById(answerId);
  const button = answer.previousElementSibling;

  if (answer.classList.contains('show')) {{
    answer.classList.remove('show');
    button.textContent = 'Показать ответ';
  }} else {{
    answer.classList.add('show');
    button.textContent = 'Скрыть ответ';
    // Перерисовываем MathJax для вновь показанного контента
    MathJax.typesetPromise([answer]).catch(function(err) {{
      console.error('MathJax typeset error:', err);
    }});
  }}
}}

// Функции таймера
function fmt(sec) {{
  const m = Math.floor(sec/60).toString().padStart(2,'0');
  const s = (sec%60).toString().padStart(2,'0');
  return m + ":" + s;
}}

function tick() {{
  const box = document.getElementById('timer');
  box.textContent = fmt(timeLeft);
  if (timeLeft <= 60) box.classList.add('urgent'); else box.classList.remove('urgent');
  if (timeLeft <= 0) {{ clearInterval(timerInterval); timerInterval = null; return; }}
  timeLeft--;
}}

function startTimer(seconds) {{
  if (timerInterval) clearInterval(timerInterval);
  timeLeft = seconds;
  tick();
  timerInterval = setInterval(tick, 1000);
}}

function resetTimer() {{
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = null;
  timeLeft = 0;
  document.getElementById('timer').textContent = "00:00";
  document.getElementById('timer').classList.remove('urgent');
}}

function clamp(v, lo, hi) {{ v = Number(v||0); if (v<lo) return lo; if (v>hi) return hi; return v; }}

function recalc() {{
  const s_defs = clamp(document.getElementById('s_defs').value, 0, 2);
  const s_closed = clamp(document.getElementById('s_closed').value, 0, 1);
  const s_proofs = clamp(document.getElementById('s_proofs').value, 0, 5);
  const s_extra = clamp(document.getElementById('s_extra').value, 0, 2);
  const base = s_defs + s_closed + s_proofs;
  const total = Math.min(8, base) + s_extra;
  document.getElementById('total').textContent = `Итог: ${{total.toFixed(2)}} / 8 (+доп до 2)`;
}}
</script>
</body>
</html>
"""

    outfile.write_text(html, encoding="utf-8")
    print(f"Готово: {outfile}")
    try:
        webbrowser.open_new_tab(outfile.as_uri())
    except Exception as e:
        print("Не удалось открыть браузер:", e)


def select_ticket():
    random.seed()
    chosen_defs = random.sample(DEFINITIONS, k=min(4, len(DEFINITIONS)))
    chosen_proofs = random.sample(PROOFS, k=min(2, len(PROOFS)))
    chosen_closed = random.choice(CLOSED)
    return chosen_defs, chosen_closed, chosen_proofs


def main():
    sel_defs, sel_closed, sel_proofs = select_ticket()
    generate_html(sel_defs, sel_closed, sel_proofs, OUTPUT_HTML)


if __name__ == "__main__":
    main()